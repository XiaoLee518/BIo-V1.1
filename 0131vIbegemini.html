<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 BioMonitor v21 - 生理訊號監測系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.css">
    <style>
        :root {
            --primary-color: #1e3a8a;
            --secondary-color: #3b82f6;
            --accent-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --light-color: #f8fafc;
            --dark-color: #1e293b;
            --text-color: #334155;
            --border-color: #e5e7eb;
            --card-bg: #ffffff;
            --sidebar-width: 250px;
            --header-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }

        body {
            background-color: var(--light-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* 主題樣式 */
        body.theme-tech {
            --primary-color: #1e3a8a;
            --secondary-color: #3b82f6;
            --accent-color: #10b981;
        }

        body.theme-zen {
            --primary-color: #065f46;
            --secondary-color: #10b981;
            --accent-color: #d97706;
        }

        body.theme-sakura {
            --primary-color: #db2777;
            --secondary-color: #f472b6;
            --accent-color: #7c3aed;
        }

        body.theme-mono {
            --primary-color: #1f2937;
            --secondary-color: #6b7280;
            --accent-color: #4b5563;
            --card-bg: #f9fafb;
        }

        /* 頂部導航欄 */
        .header {
            background-color: var(--primary-color);
            color: white;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo i {
            font-size: 2rem;
            color: var(--accent-color);
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .language-selector, .theme-selector {
            position: relative;
        }

        .language-selector select, .theme-selector select {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            outline: none;
        }

        .language-selector select option, .theme-selector select option {
            color: var(--dark-color);
        }

        /* 側邊欄 */
        .sidebar {
            position: fixed;
            top: var(--header-height);
            left: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background-color: var(--card-bg);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem 0;
            overflow-y: auto;
            z-index: 900;
            transition: transform 0.3s ease;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            color: var(--text-color);
            text-decoration: none;
            border-left: 4px solid transparent;
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background-color: rgba(59, 130, 246, 0.05);
            border-left-color: var(--secondary-color);
        }

        .nav-item.active {
            background-color: rgba(59, 130, 246, 0.1);
            border-left-color: var(--secondary-color);
            color: var(--primary-color);
            font-weight: 600;
        }

        .nav-item i {
            width: 24px;
            text-align: center;
        }

        /* 主內容區 */
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: var(--header-height);
            padding: 2rem;
            min-height: calc(100vh - var(--header-height));
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* 卡片樣式 */
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.8rem;
            border-bottom: 2px solid var(--border-color);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* 按鈕樣式 */
        .btn {
            padding: 0.7rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-color);
        }

        .btn-success {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #0da271;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-outline {
            background-color: transparent;
            color: var(--secondary-color);
            border: 1px solid var(--secondary-color);
        }

        .btn-outline:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #d97706;
        }

        /* 連線控制面板 */
        .connection-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.7rem 1.2rem;
            background-color: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .connection-status.connected {
            background-color: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.2);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--danger-color);
        }

        .status-dot.connected {
            background-color: var(--accent-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* 儀表板樣式 */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            text-align: center;
            padding: 1.5rem;
        }

        .metric-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0.5rem 0;
        }

        .metric-label {
            font-size: 1rem;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }

        .metric-unit {
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        .metric-trend {
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .trend-up {
            color: var(--accent-color);
        }

        .trend-down {
            color: var(--danger-color);
        }

        /* 圖表容器 */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin: 1.5rem 0;
        }

        /* CSV分析專用樣式 */
        .csv-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            margin: 1.5rem 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .csv-upload-area:hover {
            border-color: var(--secondary-color);
            background-color: rgba(59, 130, 246, 0.05);
        }

        .csv-upload-area.dragover {
            border-color: var(--accent-color);
            background-color: rgba(16, 185, 129, 0.05);
        }

        .csv-upload-icon {
            font-size: 3rem;
            color: var(--secondary-color);
            margin-bottom: 1rem;
        }

        .csv-preview {
            margin: 1.5rem 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .csv-preview table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .csv-preview th {
            background-color: var(--light-color);
            position: sticky;
            top: 0;
            padding: 0.8rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
        }

        .csv-preview td {
            padding: 0.6rem 0.8rem;
            border-bottom: 1px solid var(--border-color);
        }

        .csv-preview tr:hover {
            background-color: rgba(59, 130, 246, 0.05);
        }

        .csv-info {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 1.5rem 0;
            padding: 1rem;
            background-color: var(--light-color);
            border-radius: 8px;
        }

        .csv-info-item {
            flex: 1;
            min-width: 150px;
        }

        .csv-info-label {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 0.3rem;
        }

        .csv-info-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        /* 壓力指數儀表 */
        .stress-gauge {
            position: relative;
            width: 300px;
            height: 150px;
            margin: 0 auto;
        }

        .gauge-background {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 150px 150px 0 0;
            background: conic-gradient(
                #10b981 0deg,
                #34d399 60deg,
                #fbbf24 120deg,
                #f59e0b 180deg,
                #ef4444 240deg,
                #dc2626 300deg,
                #991b1b 360deg
            );
            overflow: hidden;
        }

        .gauge-center {
            position: absolute;
            width: 70%;
            height: 70%;
            background: var(--card-bg);
            border-radius: 50%;
            top: 15%;
            left: 15%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .stress-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stress-label {
            font-size: 1rem;
            color: var(--text-color);
        }

        .gauge-pointer {
            position: absolute;
            width: 4px;
            height: 45%;
            background-color: var(--dark-color);
            bottom: 50%;
            left: 50%;
            transform-origin: bottom center;
            transform: translateX(-50%) rotate(0deg);
            transition: transform 1s ease;
            border-radius: 2px 2px 0 0;
        }

        /* 報告生成樣式 */
        .report-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 1.5rem 0;
            padding: 1.5rem;
            background-color: var(--light-color);
            border-radius: 8px;
        }

        .report-section {
            margin: 2rem 0;
        }

        .report-section h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        /* 進度條 */
        .progress-container {
            margin: 1.5rem 0;
        }

        .progress-bar {
            height: 10px;
            background-color: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--accent-color);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* 頁籤切換 */
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 0.8rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-color);
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .tab-button:hover {
            color: var(--secondary-color);
        }

        .tab-button.active {
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
        }

        /* 表格樣式 */
        .table-container {
            overflow-x: auto;
            margin: 1.5rem 0;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        tbody tr:hover {
            background-color: rgba(59, 130, 246, 0.05);
        }

        /* 通知系統 */
        .notification {
            position: fixed;
            top: 90px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 2000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-success {
            border-left: 4px solid var(--accent-color);
        }

        .notification-error {
            border-left: 4px solid var(--danger-color);
        }

        .notification-info {
            border-left: 4px solid var(--secondary-color);
        }

        /* 響應式設計 */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-menu-toggle {
                display: block;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 0 1rem;
            }
            
            .logo h1 {
                font-size: 1.2rem;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .tab-buttons {
                overflow-x: auto;
            }
            
            .tab-button {
                padding: 0.8rem 1rem;
                font-size: 0.9rem;
            }
            
            .csv-upload-area {
                padding: 1.5rem;
            }
        }

        /* 移動端漢堡菜單 */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* 數據通訊狀態指示燈 */
        .comm-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: auto;
        }

        .comm-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--danger-color);
        }

        .comm-indicator.active {
            background-color: var(--accent-color);
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body class="theme-tech">
    <!-- 頂部導航欄 -->
    <header class="header">
        <div class="logo">
            <i class="fas fa-heartbeat"></i>
            <h1>ESP32 BioMonitor v21</h1>
        </div>
        
        <button class="mobile-menu-toggle" id="mobileMenuToggle">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="header-controls">
            <div class="language-selector">
                <select id="languageSelect">
                    <option value="zh-TW">繁體中文</option>
                    <option value="en">English</option>
                </select>
            </div>
            
            <div class="theme-selector">
                <select id="themeSelect">
                    <option value="tech">科技風格</option>
                    <option value="zen">禪意主題</option>
                    <option value="sakura">櫻花主題</option>
                    <option value="mono">黑白簡約</option>
                </select>
            </div>
        </div>
    </header>
    
    <!-- 側邊欄導航 -->
    <nav class="sidebar" id="sidebar">
        <a href="#live" class="nav-item active" data-tab="live">
            <i class="fas fa-heartbeat"></i>
            <span>壓力檢測 (Live)</span>
        </a>
        <a href="#raw" class="nav-item" data-tab="raw">
            <i class="fas fa-wave-square"></i>
            <span>即時監控 (Raw)</span>
        </a>
        <a href="#report" class="nav-item" data-tab="report">
            <i class="fas fa-chart-bar"></i>
            <span>數據分析 (Report)</span>
        </a>
        <a href="#all-in-one" class="nav-item" data-tab="all-in-one">
            <i class="fas fa-tachometer-alt"></i>
            <span>All-in-One (Beta)</span>
        </a>
        <a href="#manual" class="nav-item" data-tab="manual">
            <i class="fas fa-book"></i>
            <span>使用手冊</span>
        </a>
        <a href="#algorithm" class="nav-item" data-tab="algorithm">
            <i class="fas fa-code"></i>
            <span>演算法說明</span>
        </a>
        <a href="#settings" class="nav-item" data-tab="settings">
            <i class="fas fa-cog"></i>
            <span>參數設定</span>
        </a>
    </nav>
    
    <!-- 主內容區 -->
    <main class="main-content" id="mainContent">
        
        <!-- 數據分析 (Report) 頁面 -->
        <div id="report" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-chart-bar"></i> CSV數據分析與報告生成</h2>
                    <div>
                        <button class="btn btn-outline" id="exportReportBtn">
                            <i class="fas fa-file-export"></i> 匯出報告
                        </button>
                        <button class="btn btn-primary" id="printReportBtn">
                            <i class="fas fa-print"></i> 列印報告
                        </button>
                    </div>
                </div>
                
                <!-- CSV檔案上傳區域 -->
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-file-import"></i> CSV檔案上傳</h3>
                    
                    <div class="csv-upload-area" id="csvUploadArea">
                        <div class="csv-upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h3>拖放CSV檔案到此處，或點擊選擇檔案</h3>
                        <p>支援ESP32 BioMonitor v21導出的CSV格式檔案</p>
                        <button class="btn btn-primary" style="margin-top: 1rem;">
                            <i class="fas fa-folder-open"></i> 選擇CSV檔案
                        </button>
                        <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                    </div>
                    
                    <div class="csv-info" id="csvInfo" style="display: none;">
                        <div class="csv-info-item">
                            <div class="csv-info-label">檔案名稱</div>
                            <div class="csv-info-value" id="csvFileName">--</div>
                        </div>
                        <div class="csv-info-item">
                            <div class="csv-info-label">數據筆數</div>
                            <div class="csv-info-value" id="csvRowCount">0</div>
                        </div>
                        <div class="csv-info-item">
                            <div class="csv-info-label">時間範圍</div>
                            <div class="csv-info-value" id="csvTimeRange">--</div>
                        </div>
                        <div class="csv-info-item">
                            <div class="csv-info-label">檔案大小</div>
                            <div class="csv-info-value" id="csvFileSize">--</div>
                        </div>
                    </div>
                </div>
                
                <!-- 數據預覽 -->
                <div class="card" id="csvPreviewCard" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-table"></i> 數據預覽</h3>
                        <div>
                            <button class="btn btn-outline" id="showMoreDataBtn">
                                <i class="fas fa-expand"></i> 顯示更多
                            </button>
                        </div>
                    </div>
                    
                    <div class="csv-preview">
                        <table id="csvPreviewTable">
                            <thead>
                                <tr>
                                    <th>時間戳記</th>
                                    <th>心率 (HR)</th>
                                    <th>膚電 (GSR)</th>
                                    <th>呼吸頻率 (Resp)</th>
                                    <th>壓力指數</th>
                                </tr>
                            </thead>
                            <tbody id="csvPreviewBody">
                                <!-- 數據行將動態生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 數據分析頁籤 -->
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-chart-pie"></i> 統計分析報告</h3>
                    
                    <div class="tab-buttons">
                        <button class="tab-button active" data-report-tab="overview">總覽</button>
                        <button class="tab-button" data-report-tab="hr">心率分析</button>
                        <button class="tab-button" data-report-tab="gsr">膚電分析</button>
                        <button class="tab-button" data-report-tab="resp">呼吸分析</button>
                        <button class="tab-button" data-report-tab="stress">壓力分析</button>
                        <button class="tab-button" data-report-tab="anomalies">異常檢測</button>
                        <button class="tab-button" data-report-tab="correlation">相關性分析</button>
                    </div>
                    
                    <!-- 總覽頁籤 -->
                    <div id="overviewTab" class="report-tab active">
                        <div class="dashboard">
                            <div class="card metric-card">
                                <div class="metric-label">平均心率</div>
                                <div class="metric-value" id="avgHR">--</div>
                                <div class="metric-unit">BPM</div>
                                <div class="metric-trend trend-down" id="hrTrend">
                                    <i class="fas fa-arrow-down"></i> 正常範圍
                                </div>
                            </div>
                            
                            <div class="card metric-card">
                                <div class="metric-label">平均膚電</div>
                                <div class="metric-value" id="avgGSR">--</div>
                                <div class="metric-unit">μS</div>
                                <div class="metric-trend trend-up" id="gsrTrend">
                                    <i class="fas fa-arrow-up"></i> 略高於基準
                                </div>
                            </div>
                            
                            <div class="card metric-card">
                                <div class="metric-label">平均呼吸頻率</div>
                                <div class="metric-value" id="avgResp">--</div>
                                <div class="metric-unit">RPM</div>
                                <div class="metric-trend trend-down" id="respTrend">
                                    <i class="fas fa-arrow-down"></i> 正常範圍
                                </div>
                            </div>
                            
                            <div class="card metric-card">
                                <div class="metric-label">平均壓力指數</div>
                                <div class="metric-value" id="avgStress">--</div>
                                <div class="metric-unit">指數</div>
                                <div class="metric-trend" id="stressTrend">
                                    <span class="trend-down">放鬆</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-chart-line"></i> 生理訊號趨勢圖</h3>
                            <div class="chart-container">
                                <canvas id="overviewChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-table"></i> 綜合統計數據</h3>
                            <div class="table-container">
                                <table id="overviewTable">
                                    <thead>
                                        <tr>
                                            <th>指標</th>
                                            <th>平均值</th>
                                            <th>最大值</th>
                                            <th>最小值</th>
                                            <th>標準差</th>
                                            <th>變異係數</th>
                                            <th>與基準差異</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>心率 (BPM)</td>
                                            <td id="hrMean">--</td>
                                            <td id="hrMax">--</td>
                                            <td id="hrMin">--</td>
                                            <td id="hrStd">--</td>
                                            <td id="hrCV">--</td>
                                            <td id="hrDiff">--</td>
                                        </tr>
                                        <tr>
                                            <td>膚電反應 (μS)</td>
                                            <td id="gsrMean">--</td>
                                            <td id="gsrMax">--</td>
                                            <td id="gsrMin">--</td>
                                            <td id="gsrStd">--</td>
                                            <td id="gsrCV">--</td>
                                            <td id="gsrDiff">--</td>
                                        </tr>
                                        <tr>
                                            <td>呼吸頻率 (RPM)</td>
                                            <td id="respMean">--</td>
                                            <td id="respMax">--</td>
                                            <td id="respMin">--</td>
                                            <td id="respStd">--</td>
                                            <td id="respCV">--</td>
                                            <td id="respDiff">--</td>
                                        </tr>
                                        <tr>
                                            <td>壓力指數</td>
                                            <td id="stressMean">--</td>
                                            <td id="stressMax">--</td>
                                            <td id="stressMin">--</td>
                                            <td id="stressStd">--</td>
                                            <td id="stressCV">--</td>
                                            <td id="stressDiff">--</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 心率分析頁籤 -->
                    <div id="hrTab" class="report-tab" style="display: none;">
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-heart"></i> 心率分析</h3>
                            <div class="chart-container">
                                <canvas id="hrChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-chart-bar"></i> 心率分布</h3>
                            <div class="chart-container">
                                <canvas id="hrHistogram"></canvas>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-info-circle"></i> 心率變異性分析</h3>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>分析項目</th>
                                            <th>數值</th>
                                            <th>說明</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>心率變異性 (SDNN)</td>
                                            <td id="hrvSdnn">--</td>
                                            <td>正常間期標準差，反映整體心率變異性</td>
                                        </tr>
                                        <tr>
                                            <td>RMSSD</td>
                                            <td id="hrvRmssd">--</td>
                                            <td>相鄰正常間期差值的均方根，反映副交感神經活性</td>
                                        </tr>
                                        <tr>
                                            <td>pNN50 (%)</td>
                                            <td id="hrvPnn50">--</td>
                                            <td>相鄰正常間期差值大於50ms的比例</td>
                                        </tr>
                                        <tr>
                                            <td>LF/HF 比率</td>
                                            <td id="hrvLfHf">--</td>
                                            <td>低頻與高頻功率比率，反映交感與副交感平衡</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 膚電分析頁籤 -->
                    <div id="gsrTab" class="report-tab" style="display: none;">
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-tint"></i> 膚電反應分析</h3>
                            <div class="chart-container">
                                <canvas id="gsrChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-chart-bar"></i> 膚電反應統計</h3>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>統計項目</th>
                                            <th>數值</th>
                                            <th>說明</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>平均膚電反應</td>
                                            <td id="gsrAvg">--</td>
                                            <td>整體膚電反應的平均值</td>
                                        </tr>
                                        <tr>
                                            <td>最大膚電反應</td>
                                            <td id="gsrMaxVal">--</td>
                                            <td>測量期間的最大膚電反應值</td>
                                        </tr>
                                            <tr>
                                            <td>膚電反應變化幅度</td>
                                            <td id="gsrRange">--</td>
                                            <td>最大與最小膚電反應的差值</td>
                                        </tr>
                                        <tr>
                                            <td>膚電反應上升次數</td>
                                            <td id="gsrRises">--</td>
                                            <td>膚電反應顯著上升的次數</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 呼吸分析頁籤 -->
                    <div id="respTab" class="report-tab" style="display: none;">
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-lungs"></i> 呼吸頻率分析</h3>
                            <div class="chart-container">
                                <canvas id="respChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-chart-bar"></i> 呼吸模式分析</h3>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>分析項目</th>
                                            <th>數值</th>
                                            <th>說明</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>平均呼吸頻率</td>
                                            <td id="respAvg">--</td>
                                            <td>整體呼吸頻率的平均值</td>
                                        </tr>
                                        <tr>
                                            <td>呼吸頻率變異性</td>
                                            <td id="respVar">--</td>
                                            <td>呼吸頻率的標準差</td>
                                        </tr>
                                        <tr>
                                            <td>呼吸不規律指數</td>
                                            <td id="respIrregularity">--</td>
                                            <td>呼吸間隔變異性的指標</td>
                                        </tr>
                                        <tr>
                                            <td>呼吸暫停事件</td>
                                            <td id="respApnea">0</td>
                                            <td>呼吸暫停或顯著減慢的次數</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 壓力分析頁籤 -->
                    <div id="stressTab" class="report-tab" style="display: none;">
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-gauge-high"></i> 壓力指數分析</h3>
                            <div class="chart-container">
                                <canvas id="stressChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-chart-pie"></i> 壓力狀態分布</h3>
                            <div class="chart-container">
                                <canvas id="stressPieChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-weight-hanging"></i> 壓力貢獻度分析</h3>
                            <div style="display: flex; justify-content: center; margin: 1.5rem 0;">
                                <div class="stress-gauge">
                                    <div class="gauge-background"></div>
                                    <div class="gauge-center">
                                        <div class="stress-value" id="reportStressValue">--</div>
                                        <div class="stress-label">壓力指數</div>
                                    </div>
                                    <div class="gauge-pointer" id="reportGaugePointer"></div>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>生理訊號</th>
                                            <th>權重</th>
                                            <th>貢獻度</th>
                                            <th>分數</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>心率 (HR)</td>
                                            <td>60%</td>
                                            <td id="hrContributionReport">--%</td>
                                            <td id="hrScoreReport">--</td>
                                        </tr>
                                        <tr>
                                            <td>膚電反應 (GSR)</td>
                                            <td>30%</td>
                                            <td id="gsrContributionReport">--%</td>
                                            <td id="gsrScoreReport">--</td>
                                        </tr>
                                        <tr>
                                            <td>呼吸頻率 (Resp)</td>
                                            <td>10%</td>
                                            <td id="respContributionReport">--%</td>
                                            <td id="respScoreReport">--</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 異常檢測頁籤 -->
                    <div id="anomaliesTab" class="report-tab" style="display: none;">
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-exclamation-triangle"></i> 異常事件偵測</h3>
                            <div class="table-container">
                                <table id="anomaliesTable">
                                    <thead>
                                        <tr>
                                            <th>時間</th>
                                            <th>異常類型</th>
                                            <th>數值</th>
                                            <th>閾值</th>
                                            <th>持續時間</th>
                                            <th>嚴重程度</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="6" style="text-align: center;">無異常事件</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-chart-line"></i> 異常事件時間線</h3>
                            <div class="chart-container">
                                <canvas id="anomaliesChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-cogs"></i> 異常檢測設定</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1.5rem 0;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem;">心率異常閾值 (BPM)</label>
                                    <input type="number" id="hrThreshold" value="100" min="50" max="200" style="width: 100%; padding: 0.7rem; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem;">呼吸頻率異常閾值 (RPM)</label>
                                    <input type="number" id="respThreshold" value="25" min="5" max="50" style="width: 100%; padding: 0.7rem; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem;">膚電異常閾值 (μS)</label>
                                    <input type="number" id="gsrThreshold" value="4.0" min="0.5" max="10" step="0.1" style="width: 100%; padding: 0.7rem; border: 1px solid var(--border-color); border-radius: 6px;">
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-primary" id="reanalyzeAnomaliesBtn">
                                    <i class="fas fa-redo"></i> 重新分析異常
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 相關性分析頁籤 -->
                    <div id="correlationTab" class="report-tab" style="display: none;">
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-project-diagram"></i> 生理訊號相關性分析</h3>
                            <div class="chart-container">
                                <canvas id="correlationChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-table"></i> 相關性矩陣</h3>
                            <div class="table-container">
                                <table id="correlationTable">
                                    <thead>
                                        <tr>
                                            <th>變數</th>
                                            <th>心率 (HR)</th>
                                            <th>膚電 (GSR)</th>
                                            <th>呼吸頻率 (Resp)</th>
                                            <th>壓力指數</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>心率 (HR)</td>
                                            <td>1.000</td>
                                            <td id="hrGsrCorr">--</td>
                                            <td id="hrRespCorr">--</td>
                                            <td id="hrStressCorr">--</td>
                                        </tr>
                                        <tr>
                                            <td>膚電 (GSR)</td>
                                            <td id="gsrHrCorr">--</td>
                                            <td>1.000</td>
                                            <td id="gsrRespCorr">--</td>
                                            <td id="gsrStressCorr">--</td>
                                        </tr>
                                        <tr>
                                            <td>呼吸頻率 (Resp)</td>
                                            <td id="respHrCorr">--</td>
                                            <td id="respGsrCorr">--</td>
                                            <td>1.000</td>
                                            <td id="respStressCorr">--</td>
                                        </tr>
                                        <tr>
                                            <td>壓力指數</td>
                                            <td id="stressHrCorr">--</td>
                                            <td id="stressGsrCorr">--</td>
                                            <td id="stressRespCorr">--</td>
                                            <td>1.000</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3 class="card-title"><i class="fas fa-lightbulb"></i> 相關性解讀</h3>
                            <div id="correlationInsights" style="padding: 1rem;">
                                <p>相關性分析顯示生理訊號之間的相互關係：</p>
                                <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                    <li id="insight1">心率與膚電反應的正相關可能表示交感神經系統激活</li>
                                    <li id="insight2">呼吸頻率與心率的關係反映心肺耦合</li>
                                    <li id="insight3">各訊號與壓力指數的相關性顯示其對壓力的貢獻度</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 報告控制面板 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-file-export"></i> 報告匯出選項</h3>
                    </div>
                    
                    <div class="report-controls">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem;">報告格式</label>
                            <select id="reportFormat" style="padding: 0.7rem; border: 1px solid var(--border-color); border-radius: 6px; width: 200px;">
                                <option value="pdf">PDF 文件</option>
                                <option value="html">HTML 網頁</option>
                                <option value="csv">CSV 數據</option>
                                <option value="json">JSON 格式</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem;">報告範圍</label>
                            <select id="reportRange" style="padding: 0.7rem; border: 1px solid var(--border-color); border-radius: 6px; width: 200px;">
                                <option value="full">完整數據</option>
                                <option value="summary">摘要報告</option>
                                <option value="anomalies">異常報告</option>
                                <option value="custom">自訂範圍</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem;">報告語言</label>
                            <select id="reportLanguage" style="padding: 0.7rem; border: 1px solid var(--border-color); border-radius: 6px; width: 200px;">
                                <option value="zh-TW">繁體中文</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        
                        <div style="align-self: flex-end;">
                            <button class="btn btn-success" id="generateReportBtn">
                                <i class="fas fa-file-pdf"></i> 生成報告
                            </button>
                            <button class="btn btn-outline" id="downloadDataBtn">
                                <i class="fas fa-download"></i> 下載數據
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 報告摘要 -->
                <div class="card" id="reportSummary" style="display: none;">
                    <h3 class="card-title"><i class="fas fa-file-medical-alt"></i> 分析報告摘要</h3>
                    
                    <div class="report-section">
                        <h4><i class="fas fa-stethoscope"></i> 生理狀態評估</h4>
                        <p id="physioAssessment">根據分析數據，您的生理狀態...</p>
                    </div>
                    
                    <div class="report-section">
                        <h4><i class="fas fa-exclamation-circle"></i> 主要發現</h4>
                        <ul id="keyFindings" style="margin-left: 1.5rem;">
                            <li>心率平均值在正常範圍內</li>
                            <li>膚電反應顯示中等壓力水平</li>
                            <li>呼吸頻率穩定，無異常模式</li>
                        </ul>
                    </div>
                    
                    <div class="report-section">
                        <h4><i class="fas fa-clipboard-check"></i> 建議事項</h4>
                        <ul id="recommendations" style="margin-left: 1.5rem;">
                            <li>維持正常作息，確保充足睡眠</li>
                            <li>定期進行放鬆練習，如深呼吸</li>
                            <li>監控壓力水平，適時調整活動強度</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 其他頁面保持不變 -->
        <!-- 由於篇幅限制，這裡只展示CSV分析頁面 -->
        
    </main>
    
    <!-- 通知區域 -->
    <div id="notificationArea"></div>
    
    <!-- Chart.js 庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    
    <script>
        // 全局變數
        let overviewChart, hrChart, gsrChart, respChart, stressChart, hrHistogram, stressPieChart, anomaliesChart, correlationChart;
        let csvData = [];
        let currentReportTab = 'overview';
        
        // DOM 載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化圖表
            initCharts();
            
            // 設定事件監聽器
            setupEventListeners();
            
            // 初始化側邊欄導航
            initNavigation();
            
            // 顯示歡迎通知
            showNotification('CSV分析系統已就緒。請上傳ESP32 BioMonitor v21的CSV數據檔案。', 'info');
            
            // 載入範例數據（測試用）
            loadSampleData();
        });
        
        // 初始化圖表
        function initCharts() {
            // 總覽圖表
            const overviewCtx = document.getElementById('overviewChart').getContext('2d');
            overviewChart = new Chart(overviewCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '心率 (HR)',
                            data: [],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: '呼吸頻率 (Resp)',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: '壓力指數',
                            data: [],
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '時間 (秒)'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'HR / Resp'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '壓力指數'
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
            
            // 心率圖表
            const hrCtx = document.getElementById('hrChart').getContext('2d');
            hrChart = new Chart(hrCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '心率 (BPM)',
                        data: [],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '心率 (BPM)'
                            }
                        }
                    }
                }
            });
            
            // 心率直方圖
            const hrHistogramCtx = document.getElementById('hrHistogram').getContext('2d');
            hrHistogram = new Chart(hrHistogramCtx, {
                type: 'bar',
                data: {
                    labels: ['<60', '60-70', '70-80', '80-90', '90-100', '100-110', '>110'],
                    datasets: [{
                        label: '心率分布',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.7)',
                            'rgba(34, 197, 94, 0.7)',
                            'rgba(132, 204, 22, 0.7)',
                            'rgba(234, 179, 8, 0.7)',
                            'rgba(245, 158, 11, 0.7)',
                            'rgba(249, 115, 22, 0.7)',
                            'rgba(239, 68, 68, 0.7)'
                        ],
                        borderColor: [
                            'rgb(16, 185, 129)',
                            'rgb(34, 197, 94)',
                            'rgb(132, 204, 22)',
                            'rgb(234, 179, 8)',
                            'rgb(245, 158, 11)',
                            'rgb(249, 115, 22)',
                            'rgb(239, 68, 68)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '頻次'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '心率區間 (BPM)'
                            }
                        }
                    }
                }
            });
            
            // 膚電圖表
            const gsrCtx = document.getElementById('gsrChart').getContext('2d');
            gsrChart = new Chart(gsrCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '膚電反應 (μS)',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '膚電反應 (μS)'
                            }
                        }
                    }
                }
            });
            
            // 呼吸圖表
            const respCtx = document.getElementById('respChart').getContext('2d');
            respChart = new Chart(respCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '呼吸頻率 (RPM)',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '呼吸頻率 (RPM)'
                            }
                        }
                    }
                }
            });
            
            // 壓力圖表
            const stressCtx = document.getElementById('stressChart').getContext('2d');
            stressChart = new Chart(stressCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '壓力指數',
                        data: [],
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: '壓力指數'
                            }
                        }
                    }
                }
            });
            
            // 壓力餅圖
            const stressPieCtx = document.getElementById('stressPieChart').getContext('2d');
            stressPieChart = new Chart(stressPieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['放鬆 (0-39)', '輕度壓力 (40-69)', '高度壓力 (70-100)'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.7)',
                            'rgba(245, 158, 11, 0.7)',
                            'rgba(239, 68, 68, 0.7)'
                        ],
                        borderColor: [
                            'rgb(16, 185, 129)',
                            'rgb(245, 158, 11)',
                            'rgb(239, 68, 68)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} 筆 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // 異常圖表
            const anomaliesCtx = document.getElementById('anomaliesChart').getContext('2d');
            anomaliesChart = new Chart(anomaliesCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '心率',
                            data: [],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: '異常閾值',
                            data: [],
                            borderColor: '#ef4444',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        annotation: {
                            annotations: []
                        }
                    }
                }
            });
            
            // 相關性圖表
            const correlationCtx = document.getElementById('correlationChart').getContext('2d');
            correlationChart = new Chart(correlationCtx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: '心率 vs 壓力',
                            data: [],
                            backgroundColor: 'rgba(239, 68, 68, 0.5)',
                            borderColor: 'rgb(239, 68, 68)',
                            pointRadius: 5
                        },
                        {
                            label: '膚電 vs 壓力',
                            data: [],
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            borderColor: 'rgb(59, 130, 246)',
                            pointRadius: 5
                        },
                        {
                            label: '呼吸 vs 壓力',
                            data: [],
                            backgroundColor: 'rgba(16, 185, 129, 0.5)',
                            borderColor: 'rgb(16, 185, 129)',
                            pointRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '生理訊號值'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '壓力指數'
                            },
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        // 設定事件監聽器
        function setupEventListeners() {
            // CSV檔案上傳
            document.getElementById('csvUploadArea').addEventListener('click', function() {
                document.getElementById('csvFileInput').click();
            });
            
            document.getElementById('csvFileInput').addEventListener('change', handleCSVFileSelect);
            
            // 拖放檔案上傳
            const uploadArea = document.getElementById('csvUploadArea');
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.endsWith('.csv')) {
                    handleCSVFile(files[0]);
                } else {
                    showNotification('請拖放CSV格式檔案', 'error');
                }
            });
            
            // 顯示更多數據按鈕
            document.getElementById('showMoreDataBtn').addEventListener('click', function() {
                showNotification('顯示更多數據功能開發中...', 'info');
            });
            
            // 報告頁籤切換
            document.querySelectorAll('[data-report-tab]').forEach(button => {
                button.addEventListener('click', function() {
                    const tab = this.getAttribute('data-report-tab');
                    
                    // 更新按鈕狀態
                    document.querySelectorAll('[data-report-tab]').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // 顯示對應的頁籤內容
                    showReportTab(tab);
                });
            });
            
            // 重新分析異常
            document.getElementById('reanalyzeAnomaliesBtn').addEventListener('click', function() {
                analyzeAnomalies();
                showNotification('異常事件已重新分析', 'success');
            });
            
            // 生成報告
            document.getElementById('generateReportBtn').addEventListener('click', function() {
                generateReport();
            });
            
            // 下載數據
            document.getElementById('downloadDataBtn').addEventListener('click', function() {
                downloadCSVData();
            });
            
            // 匯出報告
            document.getElementById('exportReportBtn').addEventListener('click', function() {
                showNotification('報告匯出功能開發中...', 'info');
            });
            
            // 列印報告
            document.getElementById('printReportBtn').addEventListener('click', function() {
                window.print();
            });
            
            // 主題選擇
            document.getElementById('themeSelect').addEventListener('change', function() {
                setTheme(this.value);
            });
            
            // 語言選擇
            document.getElementById('languageSelect').addEventListener('click', function() {
                showNotification('語言切換為: ' + (this.value === 'zh-TW' ? '繁體中文' : 'English'), 'info');
            });
            
            // 移動端菜單切換
            document.getElementById('mobileMenuToggle').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('active');
            });
        }
        
        // 初始化側邊欄導航
        function initNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // 移除所有 active 類別
                    navItems.forEach(nav => nav.classList.remove('active'));
                    
                    // 為當前項目添加 active 類別
                    this.classList.add('active');
                    
                    // 顯示對應的內容
                    const tabId = this.getAttribute('data-tab');
                    showTab(tabId);
                    
                    // 在移動端點擊後關閉側邊欄
                    if (window.innerWidth <= 1024) {
                        document.getElementById('sidebar').classList.remove('active');
                    }
                });
            });
        }
        
        // 顯示指定頁籤內容
        function showTab(tabId) {
            // 隱藏所有內容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 顯示指定內容
            const tabElement = document.getElementById(tabId);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            
            // 更新頁面標題
            const tabName = document.querySelector(`[data-tab="${tabId}"] span`)?.textContent || 'ESP32 BioMonitor';
            document.title = `ESP32 BioMonitor v21 - ${tabName}`;
        }
        
        // 顯示報告頁籤
        function showReportTab(tab) {
            // 隱藏所有報告頁籤
            document.querySelectorAll('.report-tab').forEach(tabElement => {
                tabElement.style.display = 'none';
                tabElement.classList.remove('active');
            });
            
            // 顯示選中的報告頁籤
            const tabElement = document.getElementById(tab + 'Tab');
            if (tabElement) {
                tabElement.style.display = 'block';
                tabElement.classList.add('active');
                currentReportTab = tab;
                
                // 如果切換到相關性分析頁籤，更新圖表
                if (tab === 'correlation' && csvData.length > 0) {
                    updateCorrelationChart();
                }
            }
        }
        
        // 處理CSV檔案選擇
        function handleCSVFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleCSVFile(file);
            }
        }
        
        // 處理CSV檔案
        function handleCSVFile(file) {
            if (!file.name.endsWith('.csv')) {
                showNotification('請選擇CSV格式檔案', 'error');
                return;
            }
            
            showNotification('正在讀取CSV檔案...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    parseCSVData(content, file);
                    showNotification('CSV檔案讀取成功', 'success');
                } catch (error) {
                    console.error('CSV解析錯誤:', error);
                    showNotification('CSV檔案解析失敗: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showNotification('檔案讀取失敗', 'error');
            };
            
            reader.readAsText(file, 'UTF-8');
        }
        
        // 解析CSV數據
        function parseCSVData(content, file) {
            const lines = content.split('\n');
            const data = [];
            
            // 檢測分隔符號
            let delimiter = ',';
            if (lines[0].includes(';')) delimiter = ';';
            if (lines[0].includes('\t')) delimiter = '\t';
            
            // 解析標題行
            const headers = lines[0].split(delimiter).map(h => h.trim());
            
            // 檢查必要的欄位
            const requiredFields = ['timestamp', 'hr', 'gsr', 'resp'];
            const hasRequiredFields = requiredFields.every(field => 
                headers.some(h => h.toLowerCase().includes(field))
            );
            
            if (!hasRequiredFields) {
                showNotification('CSV檔案缺少必要欄位，請確保包含時間戳記、心率、膚電和呼吸頻率數據', 'error');
                return;
            }
            
            // 映射欄位索引
            const fieldIndices = {
                timestamp: headers.findIndex(h => h.toLowerCase().includes('timestamp') || h.toLowerCase().includes('time')),
                hr: headers.findIndex(h => h.toLowerCase().includes('hr') || h.toLowerCase().includes('heart')),
                gsr: headers.findIndex(h => h.toLowerCase().includes('gsr') || h.toLowerCase().includes('skin')),
                resp: headers.findIndex(h => h.toLowerCase().includes('resp') || h.toLowerCase().includes('breath'))
            };
            
            // 解析數據行
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = lines[i].split(delimiter).map(v => v.trim());
                
                // 檢查數據有效性
                if (values.length >= Math.max(...Object.values(fieldIndices))) {
                    const timestamp = parseFloat(values[fieldIndices.timestamp]) || Date.now();
                    const hr = parseFloat(values[fieldIndices.hr]);
                    const gsr = parseFloat(values[fieldIndices.gsr]);
                    const resp = parseFloat(values[fieldIndices.resp]);
                    
                    // 檢查數據是否有效
                    if (!isNaN(hr) && !isNaN(gsr) && !isNaN(resp)) {
                        // 計算壓力指數
                        const stress = calculateStressIndex(hr, gsr, resp);
                        
                        data.push({
                            timestamp: timestamp,
                            time: i, // 使用行號作為時間索引
                            hr: hr,
                            gsr: gsr,
                            resp: resp,
                            stress: stress
                        });
                    }
                }
            }
            
            if (data.length === 0) {
                showNotification('CSV檔案中沒有有效的數據', 'error');
                return;
            }
            
            // 儲存數據
            csvData = data;
            
            // 更新UI顯示
            updateCSVInfo(file, data);
            updateCSVPreview(data);
            analyzeCSVData(data);
            
            showNotification(`成功解析 ${data.length} 筆數據`, 'success');
        }
        
        // 計算壓力指數
        function calculateStressIndex(hr, gsr, resp) {
            // 簡化的壓力指數計算
            const hrBase = 72;
            const gsrBase = 2.5;
            const respBase = 16;
            
            const hrScore = Math.max(0, (hr - hrBase) / hrBase) * 50;
            const gsrScore = Math.max(0, (gsr - gsrBase) / gsrBase) * 30;
            const respScore = Math.max(0, (resp - respBase) / respBase) * 20;
            
            return Math.min(100, hrScore + gsrScore + respScore);
        }
        
        // 更新CSV檔案資訊
        function updateCSVInfo(file, data) {
            document.getElementById('csvInfo').style.display = 'flex';
            document.getElementById('csvFileName').textContent = file.name;
            document.getElementById('csvRowCount').textContent = data.length.toLocaleString();
            document.getElementById('csvFileSize').textContent = formatFileSize(file.size);
            
            // 計算時間範圍
            if (data.length > 0) {
                const firstTime = data[0].timestamp;
                const lastTime = data[data.length - 1].timestamp;
                const duration = (lastTime - firstTime) / 1000; // 轉換為秒
                
                if (duration > 0) {
                    document.getElementById('csvTimeRange').textContent = formatDuration(duration);
                } else {
                    document.getElementById('csvTimeRange').textContent = `${data.length} 筆數據`;
                }
            }
        }
        
        // 更新CSV預覽
        function updateCSVPreview(data) {
            document.getElementById('csvPreviewCard').style.display = 'block';
            const previewBody = document.getElementById('csvPreviewBody');
            previewBody.innerHTML = '';
            
            // 顯示前50筆數據
            const displayCount = Math.min(50, data.length);
            for (let i = 0; i < displayCount; i++) {
                const row = data[i];
                const tr = document.createElement('tr');
                
                // 格式化時間戳記
                const time = new Date(row.timestamp);
                const timeStr = isNaN(time.getTime()) ? 
                    row.timestamp : 
                    time.toLocaleTimeString();
                
                tr.innerHTML = `
                    <td>${timeStr}</td>
                    <td>${row.hr.toFixed(1)}</td>
                    <td>${row.gsr.toFixed(2)}</td>
                    <td>${row.resp.toFixed(1)}</td>
                    <td>${row.stress.toFixed(1)}</td>
                `;
                
                previewBody.appendChild(tr);
            }
            
            if (data.length > 50) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="5" style="text-align: center; font-style: italic;">... 還有 ${data.length - 50} 筆數據未顯示</td>`;
                previewBody.appendChild(tr);
            }
        }
        
        // 分析CSV數據
        function analyzeCSVData(data) {
            if (data.length === 0) return;
            
            // 提取數據陣列
            const times = data.map(d => d.time);
            const hrs = data.map(d => d.hr);
            const gsrs = data.map(d => d.gsr);
            const resps = data.map(d => d.resp);
            const stresses = data.map(d => d.stress);
            
            // 計算統計數據
            const hrStats = calculateStats(hrs);
            const gsrStats = calculateStats(gsrs);
            const respStats = calculateStats(resps);
            const stressStats = calculateStats(stresses);
            
            // 更新總覽數據
            updateOverviewData(hrStats, gsrStats, respStats, stressStats);
            
            // 更新圖表數據
            updateCharts(times, hrs, gsrs, resps, stresses);
            
            // 更新心率直方圖
            updateHRHistogram(hrs);
            
            // 更新壓力餅圖
            updateStressPieChart(stresses);
            
            // 分析異常事件
            analyzeAnomalies();
            
            // 分析相關性
            analyzeCorrelations(hrs, gsrs, resps, stresses);
            
            // 生成報告摘要
            generateReportSummary(hrStats, gsrStats, respStats, stressStats);
            
            // 顯示報告摘要
            document.getElementById('reportSummary').style.display = 'block';
        }
        
        // 計算統計數據
        function calculateStats(data) {
            if (data.length === 0) {
                return { mean: 0, min: 0, max: 0, std: 0, cv: 0 };
            }
            
            const sum = data.reduce((a, b) => a + b, 0);
            const mean = sum / data.length;
            const min = Math.min(...data);
            const max = Math.max(...data);
            
            // 計算標準差
            const variance = data.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / data.length;
            const std = Math.sqrt(variance);
            
            // 計算變異係數
            const cv = mean !== 0 ? (std / mean) * 100 : 0;
            
            return { mean, min, max, std, cv };
        }
        
        // 更新總覽數據
        function updateOverviewData(hrStats, gsrStats, respStats, stressStats) {
            // 更新儀表板
            document.getElementById('avgHR').textContent = hrStats.mean.toFixed(1);
            document.getElementById('avgGSR').textContent = gsrStats.mean.toFixed(2);
            document.getElementById('avgResp').textContent = respStats.mean.toFixed(1);
            document.getElementById('avgStress').textContent = stressStats.mean.toFixed(1);
            
            // 更新趨勢指示
            updateTrendIndicators(hrStats, gsrStats, respStats, stressStats);
            
            // 更新統計表格
            document.getElementById('hrMean').textContent = hrStats.mean.toFixed(1);
            document.getElementById('hrMin').textContent = hrStats.min.toFixed(1);
            document.getElementById('hrMax').textContent = hrStats.max.toFixed(1);
            document.getElementById('hrStd').textContent = hrStats.std.toFixed(2);
            document.getElementById('hrCV').textContent = hrStats.cv.toFixed(1) + '%';
            document.getElementById('hrDiff').textContent = ((hrStats.mean - 72) / 72 * 100).toFixed(1) + '%';
            
            document.getElementById('gsrMean').textContent = gsrStats.mean.toFixed(2);
            document.getElementById('gsrMin').textContent = gsrStats.min.toFixed(2);
            document.getElementById('gsrMax').textContent = gsrStats.max.toFixed(2);
            document.getElementById('gsrStd').textContent = gsrStats.std.toFixed(3);
            document.getElementById('gsrCV').textContent = gsrStats.cv.toFixed(1) + '%';
            document.getElementById('gsrDiff').textContent = ((gsrStats.mean - 2.5) / 2.5 * 100).toFixed(1) + '%';
            
            document.getElementById('respMean').textContent = respStats.mean.toFixed(1);
            document.getElementById('respMin').textContent = respStats.min.toFixed(1);
            document.getElementById('respMax').textContent = respStats.max.toFixed(1);
            document.getElementById('respStd').textContent = respStats.std.toFixed(2);
            document.getElementById('respCV').textContent = respStats.cv.toFixed(1) + '%';
            document.getElementById('respDiff').textContent = ((respStats.mean - 16) / 16 * 100).toFixed(1) + '%';
            
            document.getElementById('stressMean').textContent = stressStats.mean.toFixed(1);
            document.getElementById('stressMin').textContent = stressStats.min.toFixed(1);
            document.getElementById('stressMax').textContent = stressStats.max.toFixed(1);
            document.getElementById('stressStd').textContent = stressStats.std.toFixed(2);
            document.getElementById('stressCV').textContent = stressStats.cv.toFixed(1) + '%';
            document.getElementById('stressDiff').textContent = '--';
        }
        
        // 更新趨勢指示器
        function updateTrendIndicators(hrStats, gsrStats, respStats, stressStats) {
            // 心率趨勢
            const hrTrend = document.getElementById('hrTrend');
            if (hrStats.mean < 60) {
                hrTrend.innerHTML = '<i class="fas fa-arrow-down"></i> 偏低';
                hrTrend.className = 'metric-trend trend-down';
            } else if (hrStats.mean > 100) {
                hrTrend.innerHTML = '<i class="fas fa-arrow-up"></i> 偏高';
                hrTrend.className = 'metric-trend trend-up';
            } else {
                hrTrend.innerHTML = '<i class="fas fa-check-circle"></i> 正常範圍';
                hrTrend.className = 'metric-trend trend-down';
            }
            
            // 膚電趨勢
            const gsrTrend = document.getElementById('gsrTrend');
            if (gsrStats.mean < 1.5) {
                gsrTrend.innerHTML = '<i class="fas fa-arrow-down"></i> 偏低';
                gsrTrend.className = 'metric-trend trend-down';
            } else if (gsrStats.mean > 4.0) {
                gsrTrend.innerHTML = '<i class="fas fa-arrow-up"></i> 偏高';
                gsrTrend.className = 'metric-trend trend-up';
            } else {
                gsrTrend.innerHTML = '<i class="fas fa-check-circle"></i> 正常範圍';
                gsrTrend.className = 'metric-trend trend-down';
            }
            
            // 呼吸趨勢
            const respTrend = document.getElementById('respTrend');
            if (respStats.mean < 12) {
                respTrend.innerHTML = '<i class="fas fa-arrow-down"></i> 偏低';
                respTrend.className = 'metric-trend trend-down';
            } else if (respStats.mean > 20) {
                respTrend.innerHTML = '<i class="fas fa-arrow-up"></i> 偏高';
                respTrend.className = 'metric-trend trend-up';
            } else {
                respTrend.innerHTML = '<i class="fas fa-check-circle"></i> 正常範圍';
                respTrend.className = 'metric-trend trend-down';
            }
            
            // 壓力趨勢
            const stressTrend = document.getElementById('stressTrend');
            if (stressStats.mean < 40) {
                stressTrend.innerHTML = '<span class="trend-down">放鬆</span>';
            } else if (stressStats.mean < 70) {
                stressTrend.innerHTML = '<span class="trend-up">輕度壓力</span>';
            } else {
                stressTrend.innerHTML = '<span class="trend-up">高度壓力</span>';
            }
        }
        
        // 更新圖表數據
        function updateCharts(times, hrs, gsrs, resps, stresses) {
            // 限制數據點數量以避免性能問題
            const maxPoints = 200;
            const step = Math.max(1, Math.floor(times.length / maxPoints));
            
            const sampledTimes = [];
            const sampledHrs = [];
            const sampledGsrs = [];
            const sampledResps = [];
            const sampledStresses = [];
            
            for (let i = 0; i < times.length; i += step) {
                sampledTimes.push(times[i]);
                sampledHrs.push(hrs[i]);
                sampledGsrs.push(gsrs[i]);
                sampledResps.push(resps[i]);
                sampledStresses.push(stresses[i]);
            }
            
            // 更新總覽圖表
            overviewChart.data.labels = sampledTimes;
            overviewChart.data.datasets[0].data = sampledHrs;
            overviewChart.data.datasets[1].data = sampledResps;
            overviewChart.data.datasets[2].data = sampledStresses;
            overviewChart.update();
            
            // 更新心率圖表
            hrChart.data.labels = sampledTimes;
            hrChart.data.datasets[0].data = sampledHrs;
            hrChart.update();
            
            // 更新膚電圖表
            gsrChart.data.labels = sampledTimes;
            gsrChart.data.datasets[0].data = sampledGsrs;
            gsrChart.update();
            
            // 更新呼吸圖表
            respChart.data.labels = sampledTimes;
            respChart.data.datasets[0].data = sampledResps;
            respChart.update();
            
            // 更新壓力圖表
            stressChart.data.labels = sampledTimes;
            stressChart.data.datasets[0].data = sampledStresses;
            stressChart.update();
            
            // 更新壓力儀表
            const avgStress = stresses.reduce((a, b) => a + b, 0) / stresses.length;
            document.getElementById('reportStressValue').textContent = avgStress.toFixed(1);
            
            // 更新壓力儀表指針
            const angle = (avgStress / 100) * 180 - 90;
            document.getElementById('reportGaugePointer').style.transform = 
                `translateX(-50%) rotate(${angle}deg)`;
        }
        
        // 更新心率直方圖
        function updateHRHistogram(hrs) {
            // 定義心率區間
            const bins = [0, 60, 70, 80, 90, 100, 110, Infinity];
            const counts = new Array(bins.length - 1).fill(0);
            
            // 計算每個區間的數量
            hrs.forEach(hr => {
                for (let i = 0; i < bins.length - 1; i++) {
                    if (hr >= bins[i] && hr < bins[i + 1]) {
                        counts[i]++;
                        break;
                    }
                }
            });
            
            // 更新直方圖數據
            hrHistogram.data.datasets[0].data = counts;
            hrHistogram.update();
        }
        
        // 更新壓力餅圖
        function updateStressPieChart(stresses) {
            // 定義壓力等級
            const relaxed = stresses.filter(s => s < 40).length;
            const mild = stresses.filter(s => s >= 40 && s < 70).length;
            const high = stresses.filter(s => s >= 70).length;
            
            // 更新餅圖數據
            stressPieChart.data.datasets[0].data = [relaxed, mild, high];
            stressPieChart.update();
        }
        
        // 分析異常事件
        function analyzeAnomalies() {
            if (csvData.length === 0) return;
            
            const anomalies = [];
            const hrs = csvData.map(d => d.hr);
            const resps = csvData.map(d => d.resp);
            const gsrs = csvData.map(d => d.gsr);
            
            // 獲取閾值
            const hrThreshold = parseFloat(document.getElementById('hrThreshold').value) || 100;
            const respThreshold = parseFloat(document.getElementById('respThreshold').value) || 25;
            const gsrThreshold = parseFloat(document.getElementById('gsrThreshold').value) || 4.0;
            
            // 檢測異常事件
            let currentAnomaly = null;
            
            for (let i = 0; i < csvData.length; i++) {
                const dataPoint = csvData[i];
                let anomalyType = null;
                let severity = '低';
                
                // 檢查心率異常
                if (dataPoint.hr > hrThreshold) {
                    anomalyType = '心率異常';
                    severity = dataPoint.hr > hrThreshold * 1.2 ? '高' : '中';
                }
                // 檢查呼吸異常
                else if (dataPoint.resp > respThreshold) {
                    anomalyType = '呼吸異常';
                    severity = dataPoint.resp > respThreshold * 1.2 ? '高' : '中';
                }
                // 檢查膚電異常
                else if (dataPoint.gsr > gsrThreshold) {
                    anomalyType = '膚電異常';
                    severity = dataPoint.gsr > gsrThreshold * 1.2 ? '高' : '中';
                }
                
                // 處理異常事件
                if (anomalyType) {
                    if (!currentAnomaly || currentAnomaly.type !== anomalyType) {
                        // 結束上一個異常事件
                        if (currentAnomaly) {
                            currentAnomaly.endTime = i;
                            currentAnomaly.duration = currentAnomaly.endTime - currentAnomaly.startTime;
                            anomalies.push(currentAnomaly);
                        }
                        
                        // 開始新的異常事件
                        currentAnomaly = {
                            startTime: i,
                            type: anomalyType,
                            value: anomalyType === '心率異常' ? dataPoint.hr : 
                                   anomalyType === '呼吸異常' ? dataPoint.resp : dataPoint.gsr,
                            threshold: anomalyType === '心率異常' ? hrThreshold : 
                                      anomalyType === '呼吸異常' ? respThreshold : gsrThreshold,
                            severity: severity
                        };
                    }
                } else if (currentAnomaly) {
                    // 結束當前異常事件
                    currentAnomaly.endTime = i;
                    currentAnomaly.duration = currentAnomaly.endTime - currentAnomaly.startTime;
                    anomalies.push(currentAnomaly);
                    currentAnomaly = null;
                }
            }
            
            // 結束最後一個異常事件
            if (currentAnomaly) {
                currentAnomaly.endTime = csvData.length - 1;
                currentAnomaly.duration = currentAnomaly.endTime - currentAnomaly.startTime;
                anomalies.push(currentAnomaly);
            }
            
            // 更新異常事件表格
            updateAnomaliesTable(anomalies);
            
            // 更新異常事件圖表
            updateAnomaliesChart(hrs, hrThreshold, anomalies);
        }
        
        // 更新異常事件表格
        function updateAnomaliesTable(anomalies) {
            const tableBody = document.getElementById('anomaliesTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            
            if (anomalies.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 6;
                cell.textContent = '無異常事件';
                cell.style.textAlign = 'center';
                return;
            }
            
            // 顯示異常事件
            anomalies.forEach(anomaly => {
                const row = tableBody.insertRow();
                
                // 格式化時間
                const timeStr = `第${anomaly.startTime + 1}-${anomaly.endTime + 1}筆`;
                
                row.innerHTML = `
                    <td>${timeStr}</td>
                    <td>${anomaly.type}</td>
                    <td>${anomaly.value.toFixed(1)}</td>
                    <td>${anomaly.threshold}</td>
                    <td>${anomaly.duration} 筆</td>
                    <td><span style="color: ${anomaly.severity === '高' ? '#ef4444' : anomaly.severity === '中' ? '#f59e0b' : '#10b981'}">${anomaly.severity}</span></td>
                `;
            });
        }
        
        // 更新異常事件圖表
        function updateAnomaliesChart(hrs, hrThreshold, anomalies) {
            // 限制數據點數量
            const maxPoints = 100;
            const step = Math.max(1, Math.floor(hrs.length / maxPoints));
            
            const sampledHrs = [];
            const sampledTimes = [];
            const thresholdLine = [];
            
            for (let i = 0; i < hrs.length; i += step) {
                sampledHrs.push(hrs[i]);
                sampledTimes.push(i);
                thresholdLine.push(hrThreshold);
            }
            
            // 更新圖表數據
            anomaliesChart.data.labels = sampledTimes;
            anomaliesChart.data.datasets[0].data = sampledHrs;
            anomaliesChart.data.datasets[1].data = thresholdLine;
            anomaliesChart.update();
        }
        
        // 分析相關性
        function analyzeCorrelations(hrs, gsrs, resps, stresses) {
            if (hrs.length === 0) return;
            
            // 計算相關係數
            const hrGsrCorr = calculateCorrelation(hrs, gsrs);
            const hrRespCorr = calculateCorrelation(hrs, resps);
            const hrStressCorr = calculateCorrelation(hrs, stresses);
            const gsrRespCorr = calculateCorrelation(gsrs, resps);
            const gsrStressCorr = calculateCorrelation(gsrs, stresses);
            const respStressCorr = calculateCorrelation(resps, stresses);
            
            // 更新相關性矩陣
            document.getElementById('hrGsrCorr').textContent = hrGsrCorr.toFixed(3);
            document.getElementById('hrRespCorr').textContent = hrRespCorr.toFixed(3);
            document.getElementById('hrStressCorr').textContent = hrStressCorr.toFixed(3);
            
            document.getElementById('gsrHrCorr').textContent = hrGsrCorr.toFixed(3);
            document.getElementById('gsrRespCorr').textContent = gsrRespCorr.toFixed(3);
            document.getElementById('gsrStressCorr').textContent = gsrStressCorr.toFixed(3);
            
            document.getElementById('respHrCorr').textContent = hrRespCorr.toFixed(3);
            document.getElementById('respGsrCorr').textContent = gsrRespCorr.toFixed(3);
            document.getElementById('respStressCorr').textContent = respStressCorr.toFixed(3);
            
            document.getElementById('stressHrCorr').textContent = hrStressCorr.toFixed(3);
            document.getElementById('stressGsrCorr').textContent = gsrStressCorr.toFixed(3);
            document.getElementById('stressRespCorr').textContent = respStressCorr.toFixed(3);
            
            // 更新相關性解讀
            updateCorrelationInsights(hrGsrCorr, hrRespCorr, hrStressCorr);
        }
        
        // 計算相關係數
        function calculateCorrelation(x, y) {
            if (x.length !== y.length || x.length === 0) return 0;
            
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
            const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);
            
            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            
            return denominator !== 0 ? numerator / denominator : 0;
        }
        
        // 更新相關性解讀
        function updateCorrelationInsights(hrGsrCorr, hrRespCorr, hrStressCorr) {
            const insight1 = document.getElementById('insight1');
            const insight2 = document.getElementById('insight2');
            const insight3 = document.getElementById('insight3');
            
            if (hrGsrCorr > 0.5) {
                insight1.textContent = '心率與膚電反應呈現強正相關，表示交感神經系統顯著激活';
            } else if (hrGsrCorr > 0.3) {
                insight1.textContent = '心率與膚電反應呈現中等正相關，表示一定程度的交感神經激活';
            } else if (hrGsrCorr > 0) {
                insight1.textContent = '心率與膚電反應呈現弱正相關，表示輕微的交感神經激活';
            } else {
                insight1.textContent = '心率與膚電反應無明顯相關性';
            }
            
            if (hrRespCorr > 0.5) {
                insight2.textContent = '心率與呼吸頻率呈現強正相關，顯示明顯的心肺耦合現象';
            } else if (hrRespCorr > 0.3) {
                insight2.textContent = '心率與呼吸頻率呈現中等正相關，顯示一定的心肺耦合';
            } else if (hrRespCorr > 0) {
                insight2.textContent = '心率與呼吸頻率呈現弱正相關，顯示輕微的心肺耦合';
            } else {
                insight2.textContent = '心率與呼吸頻率無明顯相關性';
            }
            
            if (hrStressCorr > 0.7) {
                insight3.textContent = '心率與壓力指數高度相關，顯示心率是主要的壓力指標';
            } else if (hrStressCorr > 0.5) {
                insight3.textContent = '心率與壓力指數中度相關，是重要的壓力指標之一';
            } else {
                insight3.textContent = '心率與壓力指數相關性較低，其他生理訊號可能更重要';
            }
        }
        
        // 更新相關性圖表
        function updateCorrelationChart() {
            if (csvData.length === 0) return;
            
            // 限制數據點數量
            const maxPoints = 100;
            const step = Math.max(1, Math.floor(csvData.length / maxPoints));
            
            const hrStressData = [];
            const gsrStressData = [];
            const respStressData = [];
            
            for (let i = 0; i < csvData.length; i += step) {
                const point = csvData[i];
                hrStressData.push({ x: point.hr, y: point.stress });
                gsrStressData.push({ x: point.gsr, y: point.stress });
                respStressData.push({ x: point.resp, y: point.stress });
            }
            
            // 更新相關性圖表
            correlationChart.data.datasets[0].data = hrStressData;
            correlationChart.data.datasets[1].data = gsrStressData;
            correlationChart.data.datasets[2].data = respStressData;
            correlationChart.update();
        }
        
        // 生成報告摘要
        function generateReportSummary(hrStats, gsrStats, respStats, stressStats) {
            const assessment = document.getElementById('physioAssessment');
            const findings = document.getElementById('keyFindings');
            const recommendations = document.getElementById('recommendations');
            
            // 生成生理狀態評估
            let assessmentText = '根據分析數據，您的生理狀態';
            
            if (stressStats.mean < 40) {
                assessmentText += '處於放鬆狀態。心率、呼吸頻率和膚電反應均在正常範圍內，顯示良好的生理調節能力。';
            } else if (stressStats.mean < 70) {
                assessmentText += '處於輕度壓力狀態。部分生理指標顯示輕度激活，但仍屬正常範圍。';
            } else {
                assessmentText += '處於高度壓力狀態。多項生理指標顯示顯著激活，建議適當休息與放鬆。';
            }
            
            assessment.textContent = assessmentText;
            
            // 生成主要發現
            findings.innerHTML = '';
            const findingsList = [];
            
            if (hrStats.mean > 85) {
                findingsList.push('心率平均值偏高，可能反映交感神經系統激活');
            } else if (hrStats.mean < 60) {
                findingsList.push('心率平均值偏低，可能反映副交感神經系統優勢');
            } else {
                findingsList.push('心率平均值在正常範圍內');
            }
            
            if (gsrStats.mean > 3.5) {
                findingsList.push('膚電反應顯示較高的交感神經活性');
            } else {
                findingsList.push('膚電反應處於正常範圍');
            }
            
            if (respStats.mean > 20) {
                findingsList.push('呼吸頻率偏快，可能反映壓力或焦慮狀態');
            } else if (respStats.mean < 12) {
                findingsList.push('呼吸頻率偏慢，可能反映放鬆或鎮靜狀態');
            } else {
                findingsList.push('呼吸頻率在正常範圍內');
            }
            
            findingsList.forEach(finding => {
                const li = document.createElement('li');
                li.textContent = finding;
                findings.appendChild(li);
            });
            
            // 生成建議事項
            recommendations.innerHTML = '';
            const recommendationList = [
                '維持規律作息，確保充足睡眠',
                '定期進行放鬆練習，如深呼吸或冥想',
                '監控壓力水平，適時調整活動強度',
                '保持適度運動，促進生理健康'
            ];
            
            // 根據壓力水平添加特定建議
            if (stressStats.mean > 70) {
                recommendationList.unshift('考慮進行壓力管理訓練或諮詢專業人員');
            }
            
            if (hrStats.mean > 85) {
                recommendationList.push('練習深呼吸以降低心率');
            }
            
            recommendationList.forEach(recommendation => {
                const li = document.createElement('li');
                li.textContent = recommendation;
                recommendations.appendChild(li);
            });
        }
        
        // 生成報告
        function generateReport() {
            const format = document.getElementById('reportFormat').value;
            const range = document.getElementById('reportRange').value;
            const language = document.getElementById('reportLanguage').value;
            
            showNotification(`正在生成${format.toUpperCase()}格式報告...`, 'info');
            
            // 模擬報告生成
            setTimeout(() => {
                showNotification('報告生成完成！', 'success');
                
                // 創建下載連結
                const reportContent = generateReportContent(format);
                const blob = new Blob([reportContent], { type: getMimeType(format) });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ESP32_BioMonitor_Report_${new Date().toISOString().slice(0, 10)}.${getFileExtension(format)}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 1500);
        }
        
        // 生成報告內容
        function generateReportContent(format) {
            if (format === 'csv') {
                return generateCSVReport();
            } else if (format === 'json') {
                return generateJSONReport();
            } else {
                // HTML或PDF報告
                return generateHTMLReport();
            }
        }
        
        // 生成CSV報告
        function generateCSVReport() {
            let csv = '時間戳記,心率(BPM),膚電反應(μS),呼吸頻率(RPM),壓力指數\n';
            
            csvData.forEach(row => {
                const time = new Date(row.timestamp).toLocaleString();
                csv += `${time},${row.hr.toFixed(1)},${row.gsr.toFixed(2)},${row.resp.toFixed(1)},${row.stress.toFixed(1)}\n`;
            });
            
            return csv;
        }
        
        // 生成JSON報告
        function generateJSONReport() {
            const report = {
                metadata: {
                    generated: new Date().toISOString(),
                    dataPoints: csvData.length,
                    device: 'ESP32 BioMonitor v21'
                },
                statistics: {
                    hr: calculateStats(csvData.map(d => d.hr)),
                    gsr: calculateStats(csvData.map(d => d.gsr)),
                    resp: calculateStats(csvData.map(d => d.resp)),
                    stress: calculateStats(csvData.map(d => d.stress))
                },
                data: csvData.slice(0, 100) // 只包含前100筆數據
            };
            
            return JSON.stringify(report, null, 2);
        }
        
        // 生成HTML報告
        function generateHTMLReport() {
            const hrStats = calculateStats(csvData.map(d => d.hr));
            const gsrStats = calculateStats(csvData.map(d => d.gsr));
            const respStats = calculateStats(csvData.map(d => d.resp));
            const stressStats = calculateStats(csvData.map(d => d.stress));
            
            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ESP32 BioMonitor v21 分析報告</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; }
        h1 { color: #1e3a8a; }
        h2 { color: #3b82f6; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; }
        table { border-collapse: collapse; width: 100%; margin: 1rem 0; }
        th, td { border: 1px solid #e5e7eb; padding: 0.8rem; text-align: left; }
        th { background-color: #f8fafc; }
        .summary { background-color: #f0f9ff; padding: 1rem; border-radius: 8px; margin: 1rem 0; }
    </style>
</head>
<body>
    <h1>ESP32 BioMonitor v21 生理訊號分析報告</h1>
    <p>生成時間: ${new Date().toLocaleString()}</p>
    
    <div class="summary">
        <h2>報告摘要</h2>
        <p>本次分析包含 ${csvData.length} 筆生理訊號數據，時間範圍從 ${new Date(csvData[0].timestamp).toLocaleString()} 到 ${new Date(csvData[csvData.length-1].timestamp).toLocaleString()}。</p>
    </div>
    
    <h2>統計數據</h2>
    <table>
        <tr>
            <th>生理訊號</th>
            <th>平均值</th>
            <th>最小值</th>
            <th>最大值</th>
            <th>標準差</th>
        </tr>
        <tr>
            <td>心率 (BPM)</td>
            <td>${hrStats.mean.toFixed(1)}</td>
            <td>${hrStats.min.toFixed(1)}</td>
            <td>${hrStats.max.toFixed(1)}</td>
            <td>${hrStats.std.toFixed(2)}</td>
        </tr>
        <tr>
            <td>膚電反應 (μS)</td>
            <td>${gsrStats.mean.toFixed(2)}</td>
            <td>${gsrStats.min.toFixed(2)}</td>
            <td>${gsrStats.max.toFixed(2)}</td>
            <td>${gsrStats.std.toFixed(3)}</td>
        </tr>
        <tr>
            <td>呼吸頻率 (RPM)</td>
            <td>${respStats.mean.toFixed(1)}</td>
            <td>${respStats.min.toFixed(1)}</td>
            <td>${respStats.max.toFixed(1)}</td>
            <td>${respStats.std.toFixed(2)}</td>
        </tr>
        <tr>
            <td>壓力指數</td>
            <td>${stressStats.mean.toFixed(1)}</td>
            <td>${stressStats.min.toFixed(1)}</td>
            <td>${stressStats.max.toFixed(1)}</td>
            <td>${stressStats.std.toFixed(2)}</td>
        </tr>
    </table>
    
    <h2>分析結論</h2>
    <p>根據分析數據，平均壓力指數為 ${stressStats.mean.toFixed(1)}，屬於${stressStats.mean < 40 ? '放鬆' : stressStats.mean < 70 ? '輕度壓力' : '高度壓力'}狀態。</p>
    
    <h2>建議事項</h2>
    <ul>
        <li>維持規律作息，確保充足睡眠</li>
        <li>定期進行放鬆練習，如深呼吸或冥想</li>
        <li>監控壓力水平，適時調整活動強度</li>
        <li>保持適度運動，促進生理健康</li>
    </ul>
    
    <p style="margin-top: 2rem; font-size: 0.9rem; color: #6b7280;">
        本報告由 ESP32 BioMonitor v21 系統自動生成，僅供參考。如有健康疑慮，請諮詢專業醫療人員。
    </p>
</body>
</html>`;
        }
        
        // 下載CSV數據
        function downloadCSVData() {
            if (csvData.length === 0) {
                showNotification('沒有數據可供下載', 'error');
                return;
            }
            
            const csv = generateCSVReport();
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ESP32_BioMonitor_Data_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('CSV數據已下載', 'success');
        }
        
        // 載入範例數據（測試用）
        function loadSampleData() {
            // 創建模擬數據
            const sampleData = [];
            const startTime = Date.now() - 3600000; // 1小時前
            
            for (let i = 0; i < 300; i++) {
                const timestamp = startTime + i * 12000; // 每12秒一筆數據
                const hr = 70 + Math.random() * 20 + Math.sin(i / 10) * 5;
                const gsr = 2.0 + Math.random() * 1.5 + Math.sin(i / 15) * 0.5;
                const resp = 15 + Math.random() * 6 + Math.sin(i / 12) * 3;
                const stress = calculateStressIndex(hr, gsr, resp);
                
                sampleData.push({
                    timestamp: timestamp,
                    time: i,
                    hr: hr,
                    gsr: gsr,
                    resp: resp,
                    stress: stress
                });
            }
            
            // 模擬檔案物件
            const mockFile = {
                name: 'sample_data.csv',
                size: 12345
            };
            
            // 使用範例數據
            csvData = sampleData;
            updateCSVInfo(mockFile, sampleData);
            updateCSVPreview(sampleData);
            analyzeCSVData(sampleData);
            
            showNotification('已載入範例數據，請上傳您的CSV檔案進行分析', 'info');
        }
        
        // 輔助函數
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function formatDuration(seconds) {
            if (seconds < 60) return seconds.toFixed(0) + ' 秒';
            if (seconds < 3600) return (seconds / 60).toFixed(1) + ' 分鐘';
            return (seconds / 3600).toFixed(1) + ' 小時';
        }
        
        function getMimeType(format) {
            switch(format) {
                case 'pdf': return 'application/pdf';
                case 'html': return 'text/html';
                case 'csv': return 'text/csv';
                case 'json': return 'application/json';
                default: return 'text/plain';
            }
        }
        
        function getFileExtension(format) {
            switch(format) {
                case 'pdf': return 'pdf';
                case 'html': return 'html';
                case 'csv': return 'csv';
                case 'json': return 'json';
                default: return 'txt';
            }
        }
        
        // 設定主題
        function setTheme(theme) {
            // 移除所有主題類別
            document.body.classList.remove('theme-tech', 'theme-zen', 'theme-sakura', 'theme-mono');
            
            // 添加新主題類別
            document.body.classList.add(`theme-${theme}`);
            
            // 更新主題選擇器
            document.getElementById('themeSelect').value = theme;
            
            showNotification(`已切換為 ${getThemeName(theme)} 主題`, 'info');
        }
        
        // 取得主題名稱
        function getThemeName(theme) {
            const names = {
                'tech': '科技風格',
                'zen': '禪意主題',
                'sakura': '櫻花主題',
                'mono': '黑白簡約'
            };
            return names[theme] || theme;
        }
        
        // 顯示通知
        function showNotification(message, type = 'info') {
            const notificationArea = document.getElementById('notificationArea');
            
            // 創建通知元素
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas ${getNotificationIcon(type)}"></i>
                <span>${message}</span>
            `;
            
            // 添加到通知區域
            notificationArea.appendChild(notification);
            
            // 顯示通知
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // 自動移除通知
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }
        
        // 取得通知圖標
        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-exclamation-circle';
                case 'info': return 'fa-info-circle';
                default: return 'fa-info-circle';
            }
        }
        
        // 視窗大小改變時調整側邊欄
        window.addEventListener('resize', function() {
            if (window.innerWidth > 1024) {
                document.getElementById('sidebar').classList.remove('active');
            }
        });
    </script>
</body>
</html>